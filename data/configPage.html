<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lightscreen</title>

    <style>
        table, td {
            text-align: center; 
            vertical-align: middle;
        }
        td {
            padding-top: 0px; 
            padding-bottom: 10px; 
            padding-left: 20px; 
            padding-right: 20px; 
        }
    </style>
</head>

<body>
    <center>
    <h1>Lightscreen Einstellungen</h1>
    <table style="display: inline-block;">
        <tr>
            <td><h2>LED-Streifen (oben)</h2></td>
        </tr>
        <tr>
            <td><h2>Helligkeit einstellen:</h2></td>
        </tr>
        <tr>
            <td><div class="slidecontainer">
                <input type="range" min="1" max="255" value="255" class="slider" id="myRange">
                </div></td>
        </tr>
        <tr>
            <td><h2>Farbe einstellen:</h2></td>
        </tr>
        <tr>
            <td><div>
                <label for="colorpicker">Color Picker:</label>
                <input type="color" id="colorpicker" value="#0000ff">
            </div></td>   
        </tr>
        <tr>
            <td><h2>Zeit einstellen:</h2></td>
        </tr>
        <tr>
            <td><div>
                <label for="appt">Lightscreen an:</label>
                <input type="time" id="appt" name="appt">
            </div></td>  
        </tr>
        <tr>
            <td><div>
                <label for="appt">Lightscreen aus:</label>
                <input type="time" id="appt" name="appt">
            </div></td>
        </tr>
        <tr>
            <td><button onclick="save()">Speichern</button></td>
        </tr>
    </table>
    <table style="display: inline-block;">
        <tr>
            <td><h2>LED-Streifen (unten)</h2></td>
        </tr>
        <tr>
            <td><h2>Helligkeit einstellen:</h2></td>
        </tr>
        <tr>
            <td><div class="slidecontainer">
                <input type="range" min="1" max="255" value="255" class="slider" id="brightnessBottom">
                </div></td>
        </tr>
        <tr>
            <td><h2>Farbe einstellen:</h2></td>
        </tr>
        <tr>
            <td><div>
                <label for="colorpicker">Color Picker:</label>
                <input type="color" id="colorpicker" value="#0000ff">
            </div></td>   
        </tr>
        <tr>
            <td><h2>Zeit einstellen:</h2></td>
        </tr>
        <tr>
            <td><div>
                <label for="timeBottomUp">Lightscreen an:</label>
                <input type="time" id="timeBottomUp" name="timeBottomUp">
            </div></td>   
        </tr>
        <tr>
            <td><div>
                <label for="timeBottomDown">Lightscreen aus:</label>
                <input type="time" id="timeBottomDown" name="timeBottomDown">
            </div></td>
        </tr>
        <tr>
            <td><button onclick="saveBrightness('top')">Speichern</button></td>
        </tr>
    </table>
</center>
</body>

<script>
    function saveBrightness(strip) {
        var brightness = document.getElementById("brightnessBottom").value
        var url = "/stripBrightness?strip=" + strip + "&brightness=" + brightness;
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function(){
            saveColor(strip);
        };
        
        xhr.open("GET", url);
        xhr.setRequestHeader("Accept", "*/*");
        xhr.send();
    }

    function saveColor(strip) {
        var color = document.getElementById("colorpicker").value

        var hs = hexToHSL(color);

        var url = "/setColor?strip=" + strip + "&h=" + hs[0] + "&s=" +  hs[1];
        var xhr = new XMLHttpRequest();

        xhr.onreadystatechange = function(){

        };
        
        xhr.open("GET", url);
        xhr.setRequestHeader("Accept", "*/*");
        xhr.send();
    }

    function hexToHSL(H) {
        // Convert hex to RGB first
        let r = 0, g = 0, b = 0;
        if (H.length == 4) {
            r = "0x" + H[1] + H[1];
            g = "0x" + H[2] + H[2];
            b = "0x" + H[3] + H[3];
        } else if (H.length == 7) {
            r = "0x" + H[1] + H[2];
            g = "0x" + H[3] + H[4];
            b = "0x" + H[5] + H[6];
        }
        // Then to HSL
        r /= 255;
        g /= 255;
        b /= 255;
        let cmin = Math.min(r,g,b),
            cmax = Math.max(r,g,b),
            delta = cmax - cmin,
            h = 0,
            s = 0,
            l = 0;

        if (delta == 0)
            h = 0;
        else if (cmax == r)
            h = ((g - b) / delta) % 6;
        else if (cmax == g)
            h = (b - r) / delta + 2;
        else
            h = (r - g) / delta + 4;

        h = Math.round(h * 60);

        if (h < 0)
            h += 360;

        l = (cmax + cmin) / 2;
        s = delta == 0 ? 0 : delta / (1 - Math.abs(2 * l - 1));
        l = +(l * 100).toFixed(1);

        return [h*255/360, s*255];
    }

    </script>
</html>